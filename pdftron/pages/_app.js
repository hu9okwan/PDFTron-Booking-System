import Head from 'next/head'
import '../styles/globals.css'
import 'bootstrap/dist/css/bootstrap.min.css';
import { SessionProvider } from "next-auth/react"
import { useSession, signIn } from 'next-auth/react';
import React, {useEffect, useState} from "react";
import {addUserToDatabase, getUserIdandTeamId, isAdmin} from "../database/databaseCRUD";
import Loader from "../components/loader"
import { NavbarBS } from '../components/NavbarBS';



export default function App({
    Component,
    pageProps: { session, ...pageProps },
}) {
    return (
        <SessionProvider session={session}>
                <Head>
                    <title>PDFTron Reservation System</title>
                    <meta name="description" content="Generated by create next app"
                        key="title" />
                    <link rel="icon" href="/pdftron-icons/PDFtron.ico" />
                </Head>
            {Component.auth ? (
                <Auth>
                    <NavbarBS />
                    <Component {...pageProps} />
                </Auth>
            ) : (
                <>
                <NavbarBS />
                <Component {...pageProps} />
                </>
            )}
        </SessionProvider>
    )
}

function Auth({ children }) {
    const { data: session, status } = useSession()
    const isUser = !!session?.user
    useEffect(() => {
        if (status === "loading") return // Do nothing while loading
        if (!isUser) signIn() // If not authenticated, force log in
        //Going to figure a way to force redirect instead of just button log in.


    }, [isUser, status])

    
    
    const [isLoading, setLoading] = useState(true);
    const [userId, setUserId] = useState()
    // const [adminPriv, setAdminPriv] = useState(false)
    const [userTeamId, setUserTeamId] = useState(1)


    if (isUser) {
        if (!userId) {
            let userEmail = session.user.email
            getUserIdandTeamId(userEmail).then(objIds => {
                if (objIds.userId) {
                    setUserId(objIds.userId)
                    setUserTeamId(objIds.teamId)

                    // isAdmin(userEmail).then(bool => {
                    //     console.log("again")
                    //     setAdminPriv(bool)
                    // })
                } else {
                    addUserToDatabase(session).then(id => {
                        setUserId(id)
                    })
                }
                setLoading(false)
            })
        }

        session.user["id"] = userId
        session.user["teamId"] = userTeamId
        // session.user["adminPriv"] = adminPriv

        console.log(session)
        if (isLoading){
            return <Loader />
        }
        return children
    }


    // Session is being fetched, or no user.
    // If no user, useEffect() will redirect.
    return <Loader />
}

